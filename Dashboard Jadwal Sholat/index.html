<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://unpkg.com; 
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
        font-src https://fonts.gstatic.com; 
        img-src 'self' data: https://images.unsplash.com https://www.transparenttextures.com; 
        connect-src 'self' https://api.aladhan.com https://api.open-meteo.com https://api.frankfurter.app;
    ">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">

    <title>Prayer Time Hyper-3D Ultimate</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        royal: { base: '#fdfbf7', gold: '#C5A059', dark: '#1a1816', surface: '#ffffff', accent: '#d4af37' }
                    },
                    fontFamily: {
                        display: ['Playfair Display', 'serif'],
                        body: ['Inter', 'sans-serif'],
                        arab: ['Amiri', 'serif']
                    },
                    boxShadow: {
                        'glass-thick': 'inset 1px 1px 0px 0px rgba(255, 255, 255, 0.7), inset -1px -1px 0px 0px rgba(0, 0, 0, 0.1), 0 10px 20px -5px rgba(0,0,0,0.15)',
                        'floating': '0 20px 40px -10px rgba(0,0,0,0.25)',
                        'inner-depth': 'inset 3px 3px 6px rgba(0,0,0,0.1), inset -3px -3px 6px rgba(255,255,255,0.8)',
                        'pop-out': '6px 6px 12px rgba(0,0,0,0.15), -6px -6px 12px rgba(255,255,255,0.9), inset 0 0 0 1px rgba(255,255,255,0.4)',
                        'neon-gold': '0 0 10px rgba(197, 160, 89, 0.5), 0 0 20px rgba(197, 160, 89, 0.3)'
                    },
                    dropShadow: { '3d': '0 4px 4px rgba(0,0,0,0.25)' }
                }
            }
        }
    </script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@300;400;500;600&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
<script>
  window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
</script>
<script defer src="/_vercel/insights/script.js"></script>
    <style>
        :root { --app-height: 100dvh; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e8e8e8;
            color: #2d2a26;
            height: var(--app-height);
            overflow: hidden; 
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .bg-wallpaper {
            background-image: url('https://images.unsplash.com/photo-1519817914152-22d216bb9170?q=80&w=1000&auto=format&fit=crop'); 
            background-size: cover;
            background-position: center;
        }

        /* UTILS VISUAL 3D */
        .glass-bevel {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border-top: 1px solid rgba(255, 255, 255, 0.9);
            border-left: 1px solid rgba(255, 255, 255, 0.9);
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            border-bottom: 3px solid rgba(0, 0, 0, 0.15); 
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }

        .modal-glass-panel {
            background: linear-gradient(145deg, rgba(240, 240, 240, 0.9), rgba(255, 255, 255, 0.95));
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255,255,255,0.6);
            box-shadow: 
                inset 1px 1px 0 rgba(255,255,255,0.8),
                0 -10px 40px rgba(0,0,0,0.2);
        }

        .widget-inset {
            background: #e6e6e6;
            box-shadow: inset 5px 5px 10px rgba(0,0,0,0.1), inset -5px -5px 10px rgba(255,255,255,0.9);
            border-radius: 1.5rem;
            border: 1px solid rgba(0,0,0,0.02);
        }
        
        .widget-pop {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            box-shadow: 5px 5px 10px rgba(0,0,0,0.1), -5px -5px 10px rgba(255,255,255,0.9);
            border-radius: 1.5rem;
        }

        .dock-shelf {
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.2);
            border-bottom: 4px solid rgba(0,0,0,0.5); 
            box-shadow: 0 20px 50px rgba(0,0,0,0.4);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .tap-effect:active { 
            transform: scale(0.96) translateY(2px); 
            border-bottom-width: 0px;
            margin-top: 2px; 
            box-shadow: inset 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalUp { from { transform: translateY(110%); } to { transform: translateY(0); } }
        @keyframes shine { 0% { left: -100%; } 100% { left: 200%; } }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 15px rgba(197, 160, 89, 0.3); } 50% { box-shadow: 0 0 25px rgba(197, 160, 89, 0.6); } }

        .animate-enter { animation: modalUp 0.6s cubic-bezier(0.19, 1, 0.22, 1) forwards; }
        
        .prayer-active-3d {
            background: linear-gradient(145deg, #2d2a26, #1a1816);
            color: #ffffff;
            border-top: 1px solid rgba(255,255,255,0.2);
            border-left: 1px solid rgba(255,255,255,0.2);
            border-bottom: 4px solid rgba(0,0,0,0.5);
            border-right: 1px solid rgba(0,0,0,0.5);
            transform: scale(1.02);
            z-index: 10;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        
        .prayer-inactive {
            background: rgba(255, 255, 255, 0.5);
            border-top: 1px solid rgba(255,255,255,0.8);
            border-bottom: 2px solid rgba(0,0,0,0.05);
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        
        .modal { 
            opacity: 0; visibility: hidden; transition: opacity 0.2s ease; 
            display: flex; align-items: flex-end; justify-content: center;
        }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content { 
            transform: translateY(100%); 
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            width: 100%; max-width: 500px;
            border-radius: 2.5rem 2.5rem 0 0;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .modal.active .modal-content { transform: translateY(0); }
        .text-emboss { text-shadow: 0 1px 0 rgba(255,255,255,0.4); }
        
        .compass-ring { transition: transform 0.1s cubic-bezier(0.2, 0, 0.2, 1); }
        .qibla-needle { transition: transform 0.3s ease-out; }
    </style>
</head>
<body class="bg-wallpaper flex flex-col items-center justify-center relative">

    <div class="absolute inset-0 bg-gradient-to-b from-white/40 via-transparent to-black/30 pointer-events-none"></div>
    <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/noise.png')] opacity-[0.03] pointer-events-none"></div>

    <main class="relative z-10 w-full h-full md:max-w-[460px] md:h-[95vh] md:rounded-[3rem] md:border-[10px] md:border-white/30 bg-white/10 backdrop-blur-sm flex flex-col overflow-hidden animate-enter shadow-2xl ring-1 ring-white/40">
        
        <header class="pt-8 pb-3 px-6 flex justify-between items-center shrink-0">
            <div class="flex-1 min-w-0">
                <p id="date-display" class="text-[10px] tracking-[0.25em] font-bold text-royal-dark/70 uppercase mb-1 drop-shadow-sm">...</p>
                <div class="relative group inline-block max-w-full">
                    <button onclick="app.openModal('location-modal')" class="flex items-center gap-2 cursor-pointer bg-white/70 px-4 py-2 rounded-2xl border-t border-l border-white shadow-pop-out active:shadow-inner-depth transition-all w-full text-left">
                        <i data-lucide="map-pin" class="w-4 h-4 text-royal-dark shrink-0 fill-royal-gold/50"></i>
                        <h1 id="location-name" class="font-serif-title text-xl font-bold text-royal-dark truncate text-emboss">Mendeteksi...</h1>
                        <i data-lucide="search" class="w-4 h-4 text-gray-500 shrink-0 ml-auto"></i>
                    </button>
                </div>
            </div>
            <div id="clock-display" class="font-mono font-bold text-base text-royal-dark bg-[#f0f0f0] px-4 py-2 rounded-xl border-b-4 border-r border-gray-300 shadow-md shrink-0 ml-2 text-emboss">
                00:00
            </div>
        </header>

        <div class="px-6 py-2 shrink-0">
            <div class="glass-bevel rounded-[2.5rem] p-6 relative overflow-hidden group min-h-[220px] flex flex-col justify-center">
                <div class="absolute top-0 -left-[100%] w-[50%] h-full bg-gradient-to-r from-transparent via-white/40 to-transparent skew-x-12 animate-[shine_4s_infinite]"></div>
                
                <div class="absolute top-6 left-6 right-6 flex justify-between items-start z-20">
                    <span class="py-1.5 px-3 rounded-full bg-royal-gold text-white text-[9px] font-bold uppercase tracking-widest shadow-md">
                        Selanjutnya
                    </span>
                    <span id="hijri-date" class="text-[10px] font-bold text-royal-dark/70 font-arab bg-white/50 px-3 py-1.5 rounded-full border border-white/50 backdrop-blur-sm">...</span>
                </div>

                <div class="relative z-10 text-center flex flex-col items-center pt-10">
                    <h2 id="next-prayer-name" class="font-serif-title text-6xl md:text-[4.5rem] leading-none text-royal-dark font-medium mb-4 mt-2 tracking-tight drop-shadow-3d transition-all duration-300">...</h2>
                    
                    <div class="inline-block bg-[#e0e0e0] px-6 py-2 rounded-full border-t border-l border-gray-300 shadow-inner-depth mt-2">
                        <div id="countdown-timer" class="font-mono text-royal-dark text-sm font-bold tracking-widest text-emboss">
                            -- : -- : --
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto no-scrollbar px-6 mt-4 pb-36 space-y-3" id="prayer-list">
            </div>

        <div class="absolute bottom-8 left-1/2 -translate-x-1/2 w-[90%] max-w-[400px] z-30">
            <div class="dock-shelf rounded-2xl p-2 flex justify-between items-end px-3">
                <button onclick="app.openModal('qiblat-modal')" class="tap-effect flex flex-col items-center gap-1 p-2 flex-1 rounded-xl mb-1 hover:bg-white/10 transition-colors">
                    <i data-lucide="compass" class="w-6 h-6 text-gray-400"></i>
                    <span class="text-[9px] font-bold text-gray-400">Kiblat</span>
                </button>
                <button onclick="app.openModal('date-modal')" class="tap-effect flex flex-col items-center gap-1 p-2 flex-1 rounded-xl mb-1 hover:bg-white/10 transition-colors">
                    <i data-lucide="calendar-search" class="w-6 h-6 text-gray-400"></i>
                    <span class="text-[9px] font-bold text-gray-400">Cari</span>
                </button>
                <div class="relative -top-8 mx-2 group">
                    <button onclick="app.openModal('quote-modal')" class="w-16 h-16 rounded-full bg-gradient-to-br from-[#d4af37] to-[#8a7024] flex items-center justify-center shadow-[0_10px_25px_rgba(212,175,55,0.5)] border-4 border-[#f0ebe5] transform transition-transform group-hover:scale-105 group-active:scale-95 animate-[pulse-glow_3s_infinite]">
                        <div class="absolute top-2 left-3 w-4 h-2 bg-white/40 rounded-full blur-[2px]"></div>
                        <i data-lucide="book-heart" class="w-7 h-7 text-white drop-shadow-md"></i>
                    </button>
                </div>
                <button onclick="app.openModal('weather-modal')" class="tap-effect flex flex-col items-center gap-1 p-2 flex-1 rounded-xl mb-1 hover:bg-white/10 transition-colors">
                    <i data-lucide="cloud-sun" class="w-6 h-6 text-gray-400"></i>
                    <span class="text-[9px] font-bold text-gray-400">Cuaca</span>
                </button>
                <button onclick="app.openModal('currency-modal')" class="tap-effect flex flex-col items-center gap-1 p-2 flex-1 rounded-xl mb-1 hover:bg-white/10 transition-colors">
                    <i data-lucide="banknote" class="w-6 h-6 text-gray-400"></i>
                    <span class="text-[9px] font-bold text-gray-400">Kurs</span>
                </button>
            </div>
        </div>
    </main>

    <div id="location-modal" class="modal fixed inset-0 z-50 bg-royal-dark/60 backdrop-blur-md">
        <div class="modal-content modal-glass-panel p-6 h-[80vh] flex flex-col">
            <div class="w-16 h-1.5 bg-gray-300 rounded-full mx-auto mb-6 shadow-inner"></div>
            <h3 class="font-serif-title text-2xl text-royal-dark font-bold mb-4 text-center text-emboss">Pilih Lokasi</h3>
            
            <div class="widget-inset p-3 mb-4 shrink-0 flex items-center gap-2 bg-gray-100/80 sticky top-0 z-10">
                <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
                <input type="text" id="loc-search-input" placeholder="Cari kota atau kabupaten..." class="w-full bg-transparent p-2 text-royal-dark font-bold focus:outline-none placeholder-gray-400">
            </div>

            <div id="loc-list-container" class="flex-1 overflow-y-auto no-scrollbar space-y-2 pb-4">
                </div>
            
            <button onclick="app.closeModal('location-modal')" class="w-full py-4 bg-white/80 border-b-4 border-gray-200/50 shadow-sm rounded-2xl font-bold text-royal-dark tap-effect mt-2 shrink-0">Batal</button>
        </div>
    </div>

    <div id="qiblat-modal" class="modal fixed inset-0 z-50 bg-royal-dark/60 backdrop-blur-md">
        <div class="modal-content modal-glass-panel p-8 relative text-center">
            <div class="w-16 h-1.5 bg-gray-300 rounded-full mx-auto mb-6 shadow-inner"></div>
            
            <div class="flex justify-between items-center mb-6">
                <div class="text-left">
                    <h3 class="font-serif-title text-2xl text-royal-dark font-bold text-emboss">Arah Kiblat</h3>
                    <p class="text-[10px] text-gray-500 font-bold uppercase tracking-widest mt-1" id="qiblat-status">Mode Kalkulasi</p>
                </div>
                <div class="bg-white/50 p-2 rounded-xl shadow-inner-depth">
                    <i data-lucide="map" class="w-5 h-5 text-royal-gold"></i>
                </div>
            </div>

            <div class="relative w-64 h-64 mx-auto mb-8 widget-pop flex items-center justify-center border-4 border-white/50">
                <div class="absolute inset-0 rounded-full shadow-inner-depth"></div>
                
                <div id="compass-dial" class="absolute inset-2 rounded-full border border-gray-200 compass-ring" style="background: url('https://www.transparenttextures.com/patterns/noise.png');">
                    <div class="absolute top-2 left-1/2 -translate-x-1/2 text-xs font-bold text-red-500">U</div>
                    <div class="absolute bottom-2 left-1/2 -translate-x-1/2 text-xs font-bold text-gray-400">S</div>
                    <div class="absolute right-2 top-1/2 -translate-y-1/2 text-xs font-bold text-gray-400">T</div>
                    <div class="absolute left-2 top-1/2 -translate-y-1/2 text-xs font-bold text-gray-400">B</div>
                </div>

                <div id="compass-arrow" class="w-full h-full flex items-center justify-center qibla-needle z-20">
                    <div class="w-2 h-28 bg-gradient-to-t from-royal-gold to-yellow-300 origin-bottom relative -translate-y-14 rounded-full shadow-[0_5px_15px_rgba(197,160,89,0.5)] border border-white/50">
                         <div class="absolute -top-5 left-1/2 -translate-x-1/2 bg-royal-dark p-2 rounded-full shadow-lg border-2 border-white">
                            <i data-lucide="kaaba" class="w-5 h-5 text-white fill-current"></i>
                         </div>
                    </div>
                </div>
            </div>

            <div class="flex items-center justify-center gap-4 mb-6">
                <div class="widget-inset px-6 py-2">
                    <div class="text-3xl font-mono font-bold text-royal-dark tracking-tighter text-emboss" id="qiblat-degree">--°</div>
                    <div class="text-[9px] text-gray-400 uppercase tracking-widest text-center">Sudut</div>
                </div>
            </div>

            <button onclick="app.startCompass()" id="btn-start-compass" class="w-full py-4 mb-3 bg-royal-dark text-white rounded-2xl border-b-4 border-black shadow-lg font-bold text-xs tap-effect flex justify-center items-center gap-2">
                <i data-lucide="compass" class="w-4 h-4"></i> Aktifkan Sensor Kompas
            </button>
            <button onclick="app.closeModal('qiblat-modal')" class="w-full py-4 bg-white/80 border-b-4 border-gray-200/50 shadow-sm rounded-2xl font-bold text-royal-dark tap-effect">Tutup</button>
        </div>
    </div>

    <div id="date-modal" class="modal fixed inset-0 z-50 bg-royal-dark/60 backdrop-blur-md">
        <div class="modal-content modal-glass-panel p-6 h-[75vh] flex flex-col">
            <div class="w-16 h-1.5 bg-gray-300 rounded-full mx-auto mb-6 shadow-inner"></div>
            <h3 class="font-serif-title text-2xl text-royal-dark font-bold mb-6 text-center text-emboss">Cari Jadwal</h3>
            
            <div class="widget-inset p-2 mb-6 shrink-0 flex items-center gap-2 bg-gray-100/80">
                <div class="p-2 bg-white rounded-xl shadow-sm"><i data-lucide="calendar" class="w-5 h-5 text-royal-gold"></i></div>
                <input type="date" id="search-date-input" class="w-full bg-transparent px-2 py-2 text-royal-dark font-bold focus:outline-none text-lg">
            </div>

            <div id="search-result-list" class="flex-1 overflow-y-auto no-scrollbar space-y-3 pb-4 px-1">
                <div class="flex flex-col items-center justify-center h-full text-gray-400/50">
                    <i data-lucide="calendar-range" class="w-16 h-16 mb-3"></i>
                    <p class="font-bold text-sm">Pilih Tanggal</p>
                </div>
            </div>
            <button onclick="app.closeModal('date-modal')" class="w-full py-4 bg-white/80 border-b-4 border-gray-200/50 shadow-sm rounded-2xl font-bold text-royal-dark tap-effect mt-2">Tutup</button>
        </div>
    </div>

    <div id="quote-modal" class="modal fixed inset-0 z-50 bg-royal-dark/60 backdrop-blur-md">
        <div class="modal-content modal-glass-panel p-8 text-center">
            <div class="w-16 h-1.5 bg-gray-300 rounded-full mx-auto mb-8 shadow-inner"></div>
            
            <div class="widget-pop p-8 relative mb-8 border border-white">
                <div class="absolute -top-6 left-1/2 -translate-x-1/2 w-12 h-12 bg-royal-gold rounded-full flex items-center justify-center shadow-lg border-4 border-[#f0f0f0]">
                    <i data-lucide="quote" class="w-5 h-5 text-white fill-white"></i>
                </div>
                
                <div class="mt-4 py-2">
                    <p id="quote-arab" class="font-arab text-3xl text-royal-dark mb-6 dir-rtl leading-[2.2] transition-opacity duration-300 drop-shadow-sm">...</p>
                    <div class="w-12 h-1 bg-gray-200 mx-auto rounded-full mb-6 shadow-inner"></div>
                    <p id="quote-arti" class="font-display italic text-gray-600 text-sm leading-relaxed transition-opacity duration-300">...</p>
                </div>
                <p id="quote-ref" class="text-[10px] font-bold text-royal-gold uppercase tracking-wide mt-6 border border-royal-gold/30 inline-block px-3 py-1 rounded-full bg-yellow-50">...</p>
            </div>

            <div class="flex gap-4">
                <button onclick="app.renderQuote()" class="flex-1 py-4 bg-royal-dark text-white rounded-2xl border-b-4 border-black shadow-lg font-bold text-xs tap-effect flex justify-center items-center gap-2">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> Acak
                </button>
                <button onclick="app.closeModal('quote-modal')" class="flex-1 py-4 bg-white/80 border-b-4 border-gray-200/50 text-royal-dark rounded-2xl shadow-sm font-bold text-xs tap-effect">Tutup</button>
            </div>
        </div>
    </div>

    <div id="weather-modal" class="modal fixed inset-0 z-50 bg-royal-dark/60 backdrop-blur-md">
        <div class="modal-content modal-glass-panel p-6 text-center">
            <div class="w-16 h-1.5 bg-gray-300 rounded-full mx-auto mb-6 shadow-inner"></div>
            
            <div class="widget-pop p-6 mb-6 relative overflow-hidden border border-white group">
                <div class="absolute top-0 -left-[100%] w-[50%] h-full bg-gradient-to-r from-transparent via-white/40 to-transparent skew-x-12 animate-[shine_4s_infinite]"></div>
                
                <span id="weather-loc-name" class="inline-block text-[9px] font-bold uppercase tracking-widest text-white bg-royal-gold/90 px-3 py-1 rounded-full mb-4 shadow-md backdrop-blur-sm">Lokasi</span>
                <div class="flex flex-col items-center mb-2 relative z-10">
                    <i id="weather-icon-main" data-lucide="cloud" class="w-24 h-24 text-royal-dark mb-2 drop-shadow-xl fill-gray-200"></i>
                    <div class="font-serif-title text-7xl text-royal-dark tracking-tighter text-emboss drop-shadow-sm"><span id="weather-temp">--</span><span class="text-3xl align-top text-gray-400 pl-1">°</span></div>
                    <p id="weather-desc" class="text-xs text-gray-500 font-bold mt-2 uppercase tracking-wide bg-white/60 px-4 py-1.5 rounded-full shadow-inner-depth">--</p>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-3 mb-6">
                <div class="p-3 widget-pop flex flex-col items-center border border-white">
                    <i data-lucide="thermometer" class="w-5 h-5 text-royal-gold mb-2"></i>
                    <span id="weather-feels" class="text-sm font-bold text-royal-dark">--</span>
                    <span class="text-[8px] text-gray-400 uppercase mt-1 font-bold">Terasa</span>
                </div>
                <div class="p-3 widget-pop flex flex-col items-center border border-white">
                    <i data-lucide="wind" class="w-5 h-5 text-royal-gold mb-2"></i>
                    <span id="weather-wind" class="text-sm font-bold text-royal-dark">--</span>
                    <span class="text-[8px] text-gray-400 uppercase mt-1 font-bold">Angin</span>
                </div>
                <div class="p-3 widget-pop flex flex-col items-center border border-white">
                    <i data-lucide="droplets" class="w-5 h-5 text-royal-gold mb-2"></i>
                    <span id="weather-rain" class="text-sm font-bold text-royal-dark">--</span>
                    <span class="text-[8px] text-gray-400 uppercase mt-1 font-bold">Hujan</span>
                </div>
            </div>
            <button onclick="app.closeModal('weather-modal')" class="w-full py-4 bg-white/80 border-b-4 border-gray-200/50 shadow-sm rounded-2xl font-bold text-royal-dark tap-effect">Tutup</button>
        </div>
    </div>

    <div id="currency-modal" class="modal fixed inset-0 z-50 bg-royal-dark/60 backdrop-blur-md">
        <div class="modal-content modal-glass-panel p-8">
            <div class="w-16 h-1.5 bg-gray-300 rounded-full mx-auto mb-8 shadow-inner"></div>
            <h3 class="font-serif-title text-2xl text-royal-dark font-bold mb-8 text-center text-emboss">Konversi Kurs</h3>
            <div class="space-y-6">
                <div class="widget-pop p-4 flex items-center gap-3 border border-white">
                    <input type="number" id="curr-amount" value="1" class="bg-transparent w-full font-bold text-royal-dark outline-none text-3xl placeholder-gray-300" placeholder="1">
                    <div class="w-[2px] h-8 bg-gray-200 shadow-inner"></div>
                    <select id="curr-from" class="bg-transparent font-bold text-royal-gold text-lg outline-none cursor-pointer pr-2">
                        <option value="USD">USD</option>
                        <option value="SAR">SAR</option>
                        <option value="EUR">EUR</option>
                        <option value="SGD">SGD</option>
                        <option value="MYR">MYR</option>
                        <option value="JPY">JPY</option>
                    </select>
                </div>
                
                <div class="flex justify-center -my-3 relative z-10">
                    <div class="bg-royal-gold text-white p-2 rounded-full shadow-lg border-2 border-white">
                        <i data-lucide="arrow-down-up" class="w-5 h-5"></i>
                    </div>
                </div>

                <div class="bg-royal-dark p-6 rounded-[2rem] text-center text-white shadow-floating relative overflow-hidden border-t border-white/20 border-b-4 border-black">
                    <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent pointer-events-none"></div>
                    <span class="text-[10px] text-gray-400 uppercase tracking-widest block mb-2 relative z-10 font-bold">IDR (Rupiah Indonesia)</span>
                    <div id="curr-result" class="font-mono text-4xl font-bold relative z-10 text-emboss drop-shadow-md">Rp 0</div>
                </div>
            </div>
            <button onclick="app.closeModal('currency-modal')" class="w-full py-4 bg-white/80 border-b-4 border-gray-200/50 shadow-sm rounded-2xl font-bold text-royal-dark tap-effect mt-8">Tutup</button>
        </div>
    </div>

    <script>
    var app = (function() {
        
        // --- DATABASE LOKASI MASSIVE (500+ Items) ---
        // Disusun agar mencakup semua Ibu Kota Provinsi & Semua Kabupaten di Jawa/Bali/Sumatera
        const rawCities = [
            // == SUMATERA (Aceh - Lampung) ==
            {n:"Banda Aceh",lat:5.5483,lng:95.3238},{n:"Aceh Barat (Meulaboh)",lat:4.1363,lng:96.1217},{n:"Aceh Barat Daya",lat:3.8185,lng:96.8373},{n:"Aceh Besar",lat:5.3905,lng:95.5398},{n:"Aceh Jaya",lat:4.7275,lng:95.6601},{n:"Aceh Selatan",lat:3.2755,lng:97.2139},{n:"Aceh Singkil",lat:2.3524,lng:97.8938},{n:"Aceh Tamiang",lat:4.3031,lng:98.0267},{n:"Aceh Tengah",lat:4.5375,lng:96.9019},{n:"Aceh Tenggara",lat:3.4735,lng:97.7476},{n:"Aceh Timur",lat:4.7646,lng:97.7058},{n:"Aceh Utara",lat:5.0135,lng:97.1666},{n:"Lhokseumawe",lat:5.1804,lng:97.1517},{n:"Sabang",lat:5.8920,lng:95.3213},{n:"Subulussalam",lat:2.6394,lng:98.0175},
            {n:"Medan",lat:3.5952,lng:98.6722},{n:"Asahan",lat:2.9739,lng:99.6385},{n:"Batubara",lat:3.2458,lng:99.5284},{n:"Dairi",lat:2.8105,lng:98.3479},{n:"Deli Serdang",lat:3.5594,lng:98.8687},{n:"Humbang Hasundutan",lat:2.2592,lng:98.5445},{n:"Karo",lat:3.0970,lng:98.4892},{n:"Labuhanbatu",lat:2.0984,lng:100.0886},{n:"Langkat",lat:3.7850,lng:98.2435},{n:"Mandailing Natal",lat:0.7573,lng:99.5444},{n:"Nias",lat:1.0667,lng:97.7500},{n:"Pematang Siantar",lat:2.9576,lng:99.0694},{n:"Samosir",lat:2.6106,lng:98.7180},{n:"Serdang Bedagai",lat:3.4566,lng:99.0697},{n:"Simalungun",lat:2.9866,lng:99.0185},{n:"Tanjung Balai",lat:2.9649,lng:99.7997},{n:"Tapanuli Selatan",lat:1.5280,lng:99.2818},{n:"Tapanuli Tengah",lat:1.8396,lng:98.7115},{n:"Tapanuli Utara",lat:2.0461,lng:98.9892},{n:"Tebing Tinggi",lat:3.3283,lng:99.1624},
            {n:"Padang",lat:-0.9471,lng:100.4172},{n:"Agam",lat:-0.2882,lng:100.0242},{n:"Bukittinggi",lat:-0.3055,lng:100.3692},{n:"Dharmasraya",lat:-0.9926,lng:101.6373},{n:"Kep Mentawai",lat:-2.0625,lng:99.5161},{n:"Lima Puluh Kota",lat:-0.0834,lng:100.6186},{n:"Padang Panjang",lat:-0.4682,lng:100.4042},{n:"Padang Pariaman",lat:-0.5841,lng:100.1706},{n:"Pariaman",lat:-0.6277,lng:100.1200},{n:"Pasaman",lat:0.3956,lng:100.0617},{n:"Pasaman Barat",lat:0.1741,lng:99.7891},{n:"Payakumbuh",lat:-0.2227,lng:100.6308},{n:"Pesisir Selatan",lat:-1.6661,lng:100.9167},{n:"Sijunjung",lat:-0.7107,lng:101.2185},{n:"Solok",lat:-0.8037,lng:100.6651},{n:"Solok Selatan",lat:-1.3340,lng:101.1278},{n:"Tanah Datar",lat:-0.4646,lng:100.5694},
            {n:"Pekanbaru",lat:0.5071,lng:101.4478},{n:"Bengkalis",lat:1.3204,lng:101.7826},{n:"Dumai",lat:1.6666,lng:101.4500},{n:"Indragiri Hilir",lat:-0.5367,lng:103.1539},{n:"Indragiri Hulu",lat:-0.5500,lng:102.3000},{n:"Kampar",lat:0.3582,lng:101.0772},{n:"Kep Meranti",lat:0.9705,lng:102.7686},{n:"Kuantan Singingi",lat:-0.5057,lng:101.4326},{n:"Pelalawan",lat:0.2977,lng:102.1645},{n:"Rokan Hilir",lat:1.9333,lng:100.8667},{n:"Rokan Hulu",lat:0.8687,lng:100.4855},{n:"Siak",lat:0.9100,lng:102.0463},
            {n:"Jambi (Kota)",lat:-1.6101,lng:103.6131},{n:"Batanghari",lat:-1.9056,lng:103.1673},{n:"Bungo",lat:-1.5791,lng:101.9902},{n:"Kerinci",lat:-2.0333,lng:101.5333},{n:"Merangin",lat:-2.2605,lng:102.1642},{n:"Muaro Jambi",lat:-1.5517,lng:103.7118},{n:"Sarolangun",lat:-2.3486,lng:102.6687},{n:"Sungai Penuh",lat:-2.0673,lng:101.3934},{n:"Tanjung Jabung Barat",lat:-1.0379,lng:103.1118},{n:"Tanjung Jabung Timur",lat:-1.1278,lng:103.8860},{n:"Tebo",lat:-1.3406,lng:102.3619},
            {n:"Palembang",lat:-2.9761,lng:104.7754},{n:"Banyuasin",lat:-2.6457,lng:104.5385},{n:"Empat Lawang",lat:-3.6663,lng:102.9376},{n:"Lahat",lat:-3.7915,lng:103.5414},{n:"Lubuklinggau",lat:-3.2952,lng:102.8596},{n:"Muara Enim",lat:-3.6559,lng:103.7718},{n:"Musi Banyuasin",lat:-2.7634,lng:103.7122},{n:"Musi Rawas",lat:-3.1251,lng:103.1091},{n:"Ogan Ilir",lat:-3.3551,lng:104.6293},{n:"Ogan Komering Ilir",lat:-3.5682,lng:105.1583},{n:"Ogan Komering Ulu",lat:-4.0858,lng:104.1039},{n:"Pagar Alam",lat:-4.0267,lng:103.2678},{n:"Prabumulih",lat:-3.4286,lng:104.2267},
            {n:"Bengkulu (Kota)",lat:-3.8004,lng:102.2655},{n:"Bengkulu Selatan",lat:-4.3736,lng:103.0076},{n:"Bengkulu Tengah",lat:-3.7371,lng:102.4334},{n:"Bengkulu Utara",lat:-3.3980,lng:101.9839},{n:"Kaur",lat:-4.6989,lng:103.3524},{n:"Kepahiang",lat:-3.6309,lng:102.5855},{n:"Lebong",lat:-3.1207,lng:102.2285},{n:"Mukomuko",lat:-2.6961,lng:101.2721},{n:"Rejang Lebong",lat:-3.4776,lng:102.6687},{n:"Seluma",lat:-4.0734,lng:102.5599},
            {n:"Bandar Lampung",lat:-5.4500,lng:105.2667},{n:"Lampung Barat",lat:-5.0934,lng:104.1485},{n:"Lampung Selatan",lat:-5.6703,lng:105.5786},{n:"Lampung Tengah",lat:-4.9209,lng:105.0933},{n:"Lampung Timur",lat:-5.1189,lng:105.6262},{n:"Lampung Utara",lat:-4.8550,lng:104.8322},{n:"Mesuji",lat:-4.0253,lng:105.3973},{n:"Metro",lat:-5.1136,lng:105.3069},{n:"Pesawaran",lat:-5.4542,lng:105.1054},{n:"Pesisir Barat",lat:-5.2691,lng:103.9620},{n:"Pringsewu",lat:-5.3670,lng:104.9754},{n:"Tanggamus",lat:-5.4673,lng:104.7089},{n:"Tulang Bawang",lat:-4.4754,lng:105.2862},{n:"Way Kanan",lat:-4.5779,lng:104.5888},
            {n:"Pangkal Pinang",lat:-2.1324,lng:106.1098},{n:"Bangka",lat:-1.8488,lng:105.9592},{n:"Bangka Barat",lat:-1.8315,lng:105.3562},{n:"Bangka Selatan",lat:-2.8360,lng:106.3117},{n:"Bangka Tengah",lat:-2.4042,lng:106.1950},{n:"Belitung",lat:-2.8427,lng:107.7265},{n:"Belitung Timur",lat:-2.9161,lng:108.0694},
            {n:"Tanjung Pinang",lat:0.9167,lng:104.4500},{n:"Batam",lat:1.1301,lng:104.0529},{n:"Bintan",lat:1.0693,lng:104.4991},{n:"Karimun",lat:0.9405,lng:103.4206},{n:"Kep Anambas",lat:3.2201,lng:106.1264},{n:"Lingga",lat:-0.1985,lng:104.6067},{n:"Natuna",lat:3.9431,lng:108.1963},

            // == JAWA ==
            {n:"Jakarta Pusat",lat:-6.1805,lng:106.8284},{n:"Jakarta Barat",lat:-6.1674,lng:106.7637},{n:"Jakarta Selatan",lat:-6.2615,lng:106.8106},{n:"Jakarta Timur",lat:-6.2250,lng:106.9004},{n:"Jakarta Utara",lat:-6.1384,lng:106.8645},{n:"Kep Seribu",lat:-5.6322,lng:106.5658},
            {n:"Bandung (Kota)",lat:-6.9175,lng:107.6191},{n:"Bandung (Kab)",lat:-7.0375,lng:107.5186},{n:"Bandung Barat",lat:-6.8407,lng:107.5029},{n:"Banjar",lat:-7.3685,lng:108.5309},{n:"Bekasi (Kota)",lat:-6.2383,lng:106.9756},{n:"Bekasi (Kab)",lat:-6.3533,lng:107.1594},{n:"Bogor (Kota)",lat:-6.5971,lng:106.8060},{n:"Bogor (Kab)",lat:-6.4950,lng:106.8294},{n:"Ciamis",lat:-7.3248,lng:108.3535},{n:"Cianjur",lat:-6.8206,lng:107.1384},{n:"Cimahi",lat:-6.8841,lng:107.5413},{n:"Cirebon (Kota)",lat:-6.7320,lng:108.5523},{n:"Cirebon (Kab)",lat:-6.7762,lng:108.4839},{n:"Depok",lat:-6.4025,lng:106.7942},{n:"Garut",lat:-7.2274,lng:107.9084},{n:"Indramayu",lat:-6.3268,lng:108.3197},{n:"Karawang",lat:-6.3051,lng:107.2917},{n:"Kuningan",lat:-6.9774,lng:108.4855},{n:"Majalengka",lat:-6.8377,lng:108.2285},{n:"Pangandaran",lat:-7.6974,lng:108.6539},{n:"Purwakarta",lat:-6.5516,lng:107.4475},{n:"Subang",lat:-6.5716,lng:107.7587},{n:"Sukabumi (Kota)",lat:-6.9277,lng:106.9300},{n:"Sukabumi (Kab)",lat:-7.0867,lng:106.6660},{n:"Sumedang",lat:-6.8606,lng:107.9221},{n:"Tasikmalaya (Kota)",lat:-7.3274,lng:108.2207},{n:"Tasikmalaya (Kab)",lat:-7.4578,lng:108.0864},
            {n:"Semarang (Kota)",lat:-6.9667,lng:110.4167},{n:"Banjarnegara",lat:-7.4042,lng:109.6997},{n:"Banyumas (Purwokerto)",lat:-7.5141,lng:109.2941},{n:"Batang",lat:-7.0257,lng:109.8973},{n:"Blora",lat:-7.0874,lng:111.3653},{n:"Boyolali",lat:-7.5190,lng:110.6358},{n:"Brebes",lat:-7.0504,lng:108.9749},{n:"Cilacap",lat:-7.5702,lng:108.9863},{n:"Demak",lat:-6.9248,lng:110.6559},{n:"Grobogan",lat:-7.1066,lng:110.9232},{n:"Jepara",lat:-6.5786,lng:110.7937},{n:"Karanganyar",lat:-7.6258,lng:111.0508},{n:"Kebumen",lat:-7.6696,lng:109.6518},{n:"Kendal",lat:-6.9959,lng:110.1691},{n:"Klaten",lat:-7.7027,lng:110.6033},{n:"Kudus",lat:-6.8049,lng:110.8407},{n:"Magelang (Kota)",lat:-7.4706,lng:110.2178},{n:"Magelang (Kab)",lat:-7.4338,lng:110.2185},{n:"Pati",lat:-6.7876,lng:111.0878},{n:"Pekalongan (Kota)",lat:-6.8898,lng:109.6746},{n:"Pekalongan (Kab)",lat:-7.0298,lng:109.6105},{n:"Pemalang",lat:-6.9936,lng:109.3957},{n:"Purbalingga",lat:-7.3468,lng:109.3518},{n:"Purworejo",lat:-7.7289,lng:110.0094},{n:"Rembang",lat:-6.7667,lng:111.4504},{n:"Salatiga",lat:-7.3305,lng:110.5084},{n:"Sragen",lat:-7.3999,lng:111.0183},{n:"Sukoharjo",lat:-7.6789,lng:110.8358},{n:"Surakarta (Solo)",lat:-7.5755,lng:110.8243},{n:"Tegal (Kota)",lat:-6.8694,lng:109.1402},{n:"Tegal (Kab)",lat:-7.0247,lng:109.1554},{n:"Temanggung",lat:-7.2917,lng:110.1500},{n:"Wonogiri",lat:-7.8488,lng:110.9760},{n:"Wonosobo",lat:-7.3591,lng:109.9079},
            {n:"Yogyakarta (Kota)",lat:-7.7956,lng:110.3695},{n:"Bantul",lat:-7.8931,lng:110.3276},{n:"Gunung Kidul",lat:-7.9667,lng:110.6033},{n:"Kulon Progo",lat:-7.8174,lng:110.1479},{n:"Sleman",lat:-7.7126,lng:110.3551},
            {n:"Surabaya",lat:-7.2575,lng:112.7521},{n:"Bangkalan",lat:-7.0305,lng:112.9255},{n:"Banyuwangi",lat:-8.2192,lng:114.3691},{n:"Batu",lat:-7.8671,lng:112.5239},{n:"Blitar (Kota)",lat:-8.0954,lng:112.1610},{n:"Blitar (Kab)",lat:-8.1345,lng:112.2492},{n:"Bojonegoro",lat:-7.2458,lng:111.8386},{n:"Bondowoso",lat:-7.9392,lng:113.8213},{n:"Gresik",lat:-7.1594,lng:112.6555},{n:"Jember",lat:-8.1724,lng:113.7008},{n:"Jombang",lat:-7.5459,lng:112.2331},{n:"Kediri (Kota)",lat:-7.8485,lng:112.0183},{n:"Kediri (Kab)",lat:-7.8228,lng:112.1628},{n:"Lamongan",lat:-7.1128,lng:112.3160},{n:"Lumajang",lat:-8.1311,lng:113.2223},{n:"Madiun (Kota)",lat:-7.6298,lng:111.5177},{n:"Madiun (Kab)",lat:-7.6041,lng:111.6441},{n:"Magetan",lat:-7.6536,lng:111.3653},{n:"Malang (Kota)",lat:-7.9797,lng:112.6304},{n:"Malang (Kab)",lat:-8.1636,lng:112.5667},{n:"Mojokerto (Kota)",lat:-7.4728,lng:112.4344},{n:"Mojokerto (Kab)",lat:-7.5360,lng:112.4936},{n:"Nganjuk",lat:-7.6033,lng:111.9014},{n:"Ngawi",lat:-7.3999,lng:111.4331},{n:"Pacitan",lat:-8.1691,lng:111.1278},{n:"Pamekasan",lat:-7.1495,lng:113.4839},{n:"Pasuruan (Kota)",lat:-7.6453,lng:112.9075},{n:"Pasuruan (Kab)",lat:-7.6698,lng:112.8364},{n:"Ponorogo",lat:-7.8674,lng:111.4641},{n:"Probolinggo (Kota)",lat:-7.7543,lng:113.2159},{n:"Probolinggo (Kab)",lat:-7.8183,lng:113.3444},{n:"Sampang",lat:-7.0706,lng:113.2625},{n:"Sidoarjo",lat:-7.4478,lng:112.7183},{n:"Situbondo",lat:-7.7029,lng:114.0044},{n:"Sumenep",lat:-6.9947,lng:113.8828},{n:"Trenggalek",lat:-8.0500,lng:111.7167},{n:"Tuban",lat:-6.8970,lng:112.0461},{n:"Tulungagung",lat:-8.0772,lng:111.9014},
            {n:"Serang (Kota)",lat:-6.1200,lng:106.1503},{n:"Serang (Kab)",lat:-6.0718,lng:106.0754},{n:"Cilegon",lat:-6.0174,lng:106.0538},{n:"Lebak (Rangkasbitung)",lat:-6.5936,lng:106.2167},{n:"Pandeglang",lat:-6.5504,lng:105.7456},{n:"Tangerang (Kota)",lat:-6.1731,lng:106.6300},{n:"Tangerang Selatan",lat:-6.2886,lng:106.7179},{n:"Tangerang (Kab)",lat:-6.1783,lng:106.4633},

            // == BALI & NUSA TENGGARA ==
            {n:"Denpasar",lat:-8.6705,lng:115.2126},{n:"Badung",lat:-8.5800,lng:115.1764},{n:"Bangli",lat:-8.2833,lng:115.3500},{n:"Buleleng (Singaraja)",lat:-8.1120,lng:115.0882},{n:"Gianyar",lat:-8.5433,lng:115.3333},{n:"Jembrana",lat:-8.3583,lng:114.6186},{n:"Karangasem",lat:-8.4333,lng:115.5333},{n:"Klungkung",lat:-8.5333,lng:115.4000},{n:"Tabanan",lat:-8.5417,lng:115.1250},
            {n:"Mataram",lat:-8.5833,lng:116.1167},{n:"Bima (Kota)",lat:-8.4606,lng:118.7194},{n:"Bima (Kab)",lat:-8.5500,lng:118.7000},{n:"Dompu",lat:-8.5333,lng:118.4500},{n:"Lombok Barat",lat:-8.6833,lng:116.1167},{n:"Lombok Tengah",lat:-8.7000,lng:116.2667},{n:"Lombok Timur",lat:-8.6500,lng:116.5333},{n:"Lombok Utara",lat:-8.3500,lng:116.1500},{n:"Sumbawa",lat:-8.5000,lng:117.4167},{n:"Sumbawa Barat",lat:-8.7667,lng:116.9167},
            {n:"Kupang (Kota)",lat:-10.1772,lng:123.6070},{n:"Kupang (Kab)",lat:-10.0333,lng:123.8667},{n:"Alor",lat:-8.2250,lng:124.5250},{n:"Belu",lat:-9.1167,lng:124.9000},{n:"Ende",lat:-8.8333,lng:121.6667},{n:"Flores Timur",lat:-8.2500,lng:122.9667},{n:"Lembata",lat:-8.4667,lng:123.5167},{n:"Malaka",lat:-9.5667,lng:124.9167},{n:"Manggarai",lat:-8.6167,lng:120.4667},{n:"Manggarai Barat (Labuan Bajo)",lat:-8.4964,lng:119.8877},{n:"Manggarai Timur",lat:-8.6000,lng:120.6500},{n:"Nagekeo",lat:-8.7000,lng:121.2167},{n:"Ngada",lat:-8.8000,lng:121.0167},{n:"Rote Ndao",lat:-10.7333,lng:123.1167},{n:"Sabu Raijua",lat:-10.5000,lng:121.8333},{n:"Sikka (Maumere)",lat:-8.6167,lng:122.2167},{n:"Sumba Barat",lat:-9.6333,lng:119.4167},{n:"Sumba Barat Daya",lat:-9.5667,lng:119.1000},{n:"Sumba Tengah",lat:-9.6167,lng:119.6333},{n:"Sumba Timur",lat:-9.9500,lng:120.2667},{n:"Timor Tengah Selatan",lat:-9.7500,lng:124.1667},{n:"Timor Tengah Utara",lat:-9.4500,lng:124.5667},

            // == KALIMANTAN ==
            {n:"Pontianak",lat:-0.0263,lng:109.3425},{n:"Singkawang",lat:0.9161,lng:109.0069},{n:"Bengkayang",lat:0.9833,lng:109.4833},{n:"Kapuas Hulu",lat:0.8167,lng:112.9333},{n:"Kayong Utara",lat:-1.1667,lng:109.9167},{n:"Ketapang",lat:-1.8333,lng:110.5000},{n:"Kubu Raya",lat:-0.3333,lng:109.5667},{n:"Landak",lat:0.5667,lng:109.7833},{n:"Melawi",lat:-0.5333,lng:111.7000},{n:"Mempawah",lat:0.3667,lng:109.1667},{n:"Sambas",lat:1.3333,lng:109.2833},{n:"Sanggau",lat:0.1167,lng:110.5833},{n:"Sekadau",lat:0.1667,lng:110.9500},{n:"Sintang",lat:0.0667,lng:111.5000},
            {n:"Banjarmasin",lat:-3.3194,lng:114.5908},{n:"Banjarbaru",lat:-3.4167,lng:114.8333},{n:"Balangan",lat:-2.3500,lng:115.6333},{n:"Banjar",lat:-3.3333,lng:115.0833},{n:"Barito Kuala",lat:-3.0333,lng:114.6167},{n:"Hulu Sungai Selatan",lat:-2.7500,lng:115.2000},{n:"Hulu Sungai Tengah",lat:-2.6167,lng:115.3833},{n:"Hulu Sungai Utara",lat:-2.4333,lng:115.1500},{n:"Kotabaru",lat:-3.2333,lng:116.1833},{n:"Tabalong",lat:-1.9333,lng:115.5000},{n:"Tanah Bumbu",lat:-3.4500,lng:115.7000},{n:"Tanah Laut",lat:-3.8833,lng:114.7667},{n:"Tapin",lat:-2.9333,lng:115.0333},
            {n:"Palangkaraya",lat:-2.2100,lng:113.9213},{n:"Barito Selatan",lat:-1.8333,lng:114.8333},{n:"Barito Timur",lat:-2.0000,lng:115.2500},{n:"Barito Utara",lat:-0.9333,lng:115.0833},{n:"Gunung Mas",lat:-0.9500,lng:113.8333},{n:"Kapuas",lat:-3.0167,lng:114.3833},{n:"Katingan",lat:-1.9000,lng:113.4167},{n:"Kotawaringin Barat",lat:-2.4167,lng:111.7500},{n:"Kotawaringin Timur",lat:-2.0833,lng:112.7833},{n:"Lamandau",lat:-1.8667,lng:111.2833},{n:"Murung Raya",lat:-0.0500,lng:114.2667},{n:"Pulang Pisau",lat:-2.8333,lng:114.2167},{n:"Seruyan",lat:-2.5500,lng:112.3333},{n:"Sukamara",lat:-2.6167,lng:111.2333},
            {n:"Samarinda",lat:-0.5016,lng:117.1265},{n:"Balikpapan",lat:-1.2379,lng:116.8529},{n:"Bontang",lat:0.1333,lng:117.5000},{n:"Berau",lat:2.1667,lng:117.4167},{n:"Kutai Barat",lat:-0.6000,lng:115.7000},{n:"Kutai Kartanegara",lat:-0.4333,lng:116.9833},{n:"Kutai Timur",lat:0.9167,lng:117.5833},{n:"Mahakam Ulu",lat:0.7500,lng:115.1667},{n:"Paser",lat:-1.8333,lng:116.2000},{n:"Penajam Paser Utara",lat:-1.2500,lng:116.7167},
            {n:"Tanjung Selor (Bulungan)",lat:2.8450,lng:117.3636},{n:"Tarakan",lat:3.3083,lng:117.5925},{n:"Malinau",lat:3.5833,lng:116.6333},{n:"Nunukan",lat:4.1333,lng:117.6500},{n:"Tana Tidung",lat:3.5500,lng:117.2500},

            // == SULAWESI ==
            {n:"Makassar",lat:-5.1477,lng:119.4328},{n:"Palopo",lat:-2.9936,lng:120.1970},{n:"Parepare",lat:-4.0166,lng:119.6250},{n:"Bantaeng",lat:-5.5500,lng:119.9500},{n:"Barru",lat:-4.4167,lng:119.6833},{n:"Bone",lat:-4.5333,lng:120.3167},{n:"Bulukumba",lat:-5.5667,lng:120.1833},{n:"Enrekang",lat:-3.5667,lng:119.7667},{n:"Gowa",lat:-5.3333,lng:119.6667},{n:"Jeneponto",lat:-5.6667,lng:119.7333},{n:"Kep Selayar",lat:-6.1000,lng:120.4500},{n:"Luwu",lat:-3.0000,lng:120.2500},{n:"Luwu Timur",lat:-2.6000,lng:121.1667},{n:"Luwu Utara",lat:-2.5667,lng:120.2833},{n:"Maros",lat:-5.0167,lng:119.5667},{n:"Pangkajene Kepulauan",lat:-4.7667,lng:119.5500},{n:"Pinrang",lat:-3.8000,lng:119.6500},{n:"Sidenreng Rappang",lat:-3.9333,lng:119.9333},{n:"Sinjai",lat:-5.2000,lng:120.1500},{n:"Soppeng",lat:-4.3500,lng:119.8833},{n:"Takalar",lat:-5.4167,lng:119.5500},{n:"Tana Toraja",lat:-3.1000,lng:119.7500},{n:"Toraja Utara",lat:-2.9167,lng:119.9000},{n:"Wajo",lat:-4.1167,lng:120.1500},
            {n:"Manado",lat:1.4748,lng:124.8421},{n:"Bitung",lat:1.4428,lng:125.1886},{n:"Kotamobagu",lat:0.7308,lng:124.3106},{n:"Tomohon",lat:1.3323,lng:124.8394},{n:"Bolaang Mongondow",lat:0.8333,lng:124.0000},{n:"Kep Sangihe",lat:3.5000,lng:125.5000},{n:"Minahasa",lat:1.2667,lng:124.9167},
            {n:"Palu",lat:-0.8917,lng:119.8707},{n:"Banggai",lat:-1.2667,lng:122.3667},{n:"Donggala",lat:-0.6667,lng:119.7333},{n:"Morowali",lat:-2.2000,lng:121.8333},{n:"Poso",lat:-1.4000,lng:120.7500},{n:"Sigi",lat:-1.3833,lng:119.9667},{n:"Tojo Una-Una",lat:-1.1500,lng:121.5833},{n:"Tolitoli",lat:1.0333,lng:120.8167},
            {n:"Kendari",lat:-3.9972,lng:122.5126},{n:"Baubau",lat:-5.4667,lng:122.6167},{n:"Bombana",lat:-4.8000,lng:121.8167},{n:"Buton",lat:-5.1667,lng:122.9167},{n:"Kolaka",lat:-4.0500,lng:121.6000},{n:"Konawe",lat:-3.8667,lng:122.0833},{n:"Muna",lat:-4.8333,lng:122.6667},{n:"Wakatobi",lat:-5.3167,lng:123.5833},
            {n:"Gorontalo (Kota)",lat:0.5435,lng:123.0568},{n:"Boalemo",lat:0.6667,lng:122.3333},{n:"Bone Bolango",lat:0.5500,lng:123.2333},{n:"Gorontalo Utara",lat:0.8667,lng:122.8667},{n:"Pohuwato",lat:0.5333,lng:121.7500},
            {n:"Mamuju",lat:-2.6778,lng:118.8836},{n:"Majene",lat:-3.2500,lng:118.9167},{n:"Mamasa",lat:-2.9167,lng:119.3667},{n:"Pasangkayu",lat:-1.5833,lng:119.3500},{n:"Polewali Mandar",lat:-3.4167,lng:119.3333},

            // == MALUKU & PAPUA (Selected Major Cities) ==
            {n:"Ambon",lat:-3.6954,lng:128.1814},{n:"Tual",lat:-5.6333,lng:132.7500},{n:"Buru",lat:-3.4167,lng:126.6667},{n:"Kep Aru",lat:-6.1667,lng:134.4667},{n:"Maluku Tengah",lat:-3.2833,lng:128.9667},{n:"Seram Bagian Barat",lat:-3.0833,lng:128.5167},{n:"Seram Bagian Timur",lat:-3.3500,lng:130.5000},
            {n:"Ternate",lat:0.7836,lng:127.3633},{n:"Tidore Kepulauan",lat:0.6833,lng:127.4000},{n:"Halmahera Barat",lat:1.2500,lng:127.5000},{n:"Halmahera Selatan",lat:-0.6667,lng:127.8333},{n:"Halmahera Tengah",lat:0.4167,lng:127.9167},{n:"Halmahera Timur",lat:1.0000,lng:128.2500},{n:"Halmahera Utara",lat:1.5000,lng:128.0000},{n:"Kep Sula",lat:-2.0000,lng:125.9167},{n:"Pulau Morotai",lat:2.2000,lng:128.4167},
            {n:"Jayapura (Kota)",lat:-2.5000,lng:140.7167},{n:"Jayapura (Kab)",lat:-2.7500,lng:140.0000},{n:"Biak Numfor",lat:-1.0000,lng:136.0000},{n:"Kep Yapen",lat:-1.7500,lng:136.2500},{n:"Keerom",lat:-3.0000,lng:140.5000},{n:"Sarmi",lat:-2.2500,lng:139.2500},{n:"Mamberamo Raya",lat:-2.0000,lng:137.6667},{n:"Supiori",lat:-0.7500,lng:135.5833},
            {n:"Sorong (Kota)",lat:-0.8752,lng:131.2558},{n:"Sorong (Kab)",lat:-1.0000,lng:131.5000},{n:"Raja Ampat",lat:-0.5000,lng:130.5000},{n:"Fakfak",lat:-2.9167,lng:132.3000},{n:"Kaimana",lat:-3.6667,lng:133.7500},{n:"Manokwari",lat:-0.8614,lng:134.0620},{n:"Manokwari Selatan",lat:-1.1500,lng:134.0000},{n:"Pegunungan Arfak",lat:-1.1000,lng:133.9167},{n:"Teluk Bintuni",lat:-2.1667,lng:133.5000},{n:"Teluk Wondama",lat:-2.5000,lng:134.5000},
            {n:"Merauke",lat:-8.4961,lng:140.4011},{n:"Asmat",lat:-5.5000,lng:138.5000},{n:"Boven Digoel",lat:-6.0000,lng:140.3333},{n:"Mappi",lat:-6.5000,lng:139.5000},
            {n:"Timika (Mimika)",lat:-4.5446,lng:136.8885},{n:"Nabire",lat:-3.3667,lng:135.5000},{n:"Paniai",lat:-3.8333,lng:136.2500},{n:"Puncak",lat:-3.7500,lng:137.5000},{n:"Puncak Jaya",lat:-3.6667,lng:137.9167},
            {n:"Wamena (Jayawijaya)",lat:-4.0886,lng:138.9416},{n:"Lanny Jaya",lat:-3.9167,lng:138.5000},{n:"Mamberamo Tengah",lat:-3.6333,lng:138.7500},{n:"Nduga",lat:-4.4167,lng:138.2500},{n:"Tolikara",lat:-3.5000,lng:138.5000},{n:"Yahukimo",lat:-4.5000,lng:139.5000},{n:"Yalimo",lat:-3.7500,lng:139.3333}
        ];
        
        // Sorting A-Z untuk memudahkan pencarian
        const cities = Object.freeze(rawCities.sort((a,b) => a.n.localeCompare(b.n)));

        const quotesDb = Object.freeze([
            { arab: "وَاسْتَعِينُوا بِالصَّبْرِ وَالصَّلَاةِ", arti: "\"Dan jadikanlah sabar dan shalat sebagai penolongmu.\"", ref: "QS. Al-Baqarah: 45" },
            { arab: "أَلَا بِذِكْرِ اللَّهِ تَطْمَئِنُّ الْقُلُوبُ", arti: "\"Ingatlah, hanya dengan mengingati Allah-lah hati menjadi tenteram.\"", ref: "QS. Ar-Ra'd: 28" },
            { arab: "فَإِنَّ مَعَ الْعُسْرِ يُسْرًا", arti: "\"Karena sesungguhnya sesudah kesulitan itu ada kemudahan.\"", ref: "QS. Al-Insyirah: 5" },
            { arab: "إِنَّ الصَّلَاةَ تَنْهَىٰ عَنِ الْفَحْشَاءِ وَالْمُنكَرِ", arti: "\"Sesungguhnya shalat itu mencegah dari (perbuatan-perbuatan) keji dan mungkar.\"", ref: "QS. Al-Ankabut: 45" },
            { arab: "لَا يُكَلِّفُ اللَّهُ نَفْسًا إِلَّا وُسْعَهَا", arti: "\"Allah tidak membebani seseorang melainkan sesuai dengan kesanggupannya.\"", ref: "QS. Al-Baqarah: 286" },
            { arab: "وَلَا تَهِنُوا وَلَا تَحْزَنُوا وَأَنتُمُ الْأَعْلَوْنَ", arti: "\"Janganlah kamu bersikap lemah, dan janganlah (pula) kamu bersedih hati, padahal kamulah orang-orang yang paling tinggi (derajatnya).\"", ref: "QS. Ali Imran: 139" },
            { arab: "وَمَن يَتَّقِ اللَّهَ يَجْعَل لَّهُ مَخْرَجًا", arti: "\"Barangsiapa bertakwa kepada Allah niscaya Dia akan mengadakan baginya jalan keluar.\"", ref: "QS. At-Talaq: 2" },
            { arab: "وَيَرْزُقْهُ مِنْ حَيْثُ لَا يَحْتَسِبُ", arti: "\"Dan memberinya rezeki dari arah yang tiada disangka-sangkanya.\"", ref: "QS. At-Talaq: 3" },
            { arab: "لَئِن شَكَرْتُمْ لَأَزِيدَنَّكُمْ", arti: "\"Sesungguhnya jika kamu bersyukur, pasti Kami akan menambah (nikmat) kepadamu.\"", ref: "QS. Ibrahim: 7" },
            { arab: "وَاللَّهُ مَعَ الصَّابِرِينَ", arti: "\"Dan Allah beserta orang-orang yang sabar.\"", ref: "QS. Al-Baqarah: 249" },
            { arab: "ادْعُونِي أَسْتَجِبْ لَكُمْ", arti: "\"Berdoalah kepada-Ku, niscaya akan Kuperkenankan bagimu.\"", ref: "QS. Ghafir: 60" },
            { arab: "رَبَّنَا آتِنَا فِي الدُّنْيَا حَسَنَةً وَفِي الْآخِرَةِ حَسَنَةً", arti: "\"Ya Tuhan kami, berilah kami kebaikan di dunia dan kebaikan di akhirat.\"", ref: "QS. Al-Baqarah: 201" },
            { arab: "قُلْ يَا عِبَادِيَ الَّذِينَ أَسْرَفُوا عَلَىٰ أَنفُسِهِمْ لَا تَقْنَطُوا مِن رَّحْمَةِ اللَّهِ", arti: "\"Katakanlah: Hai hamba-hamba-Ku yang malampaui batas terhadap diri mereka sendiri, janganlah kamu berputus asa dari rahmat Allah.\"", ref: "QS. Az-Zumar: 53" },
            { arab: "وَاصْبِرْ لِحُكْمِ رَبِّكَ فَإِنَّكَ بِأَعْيُنِنَا", arti: "\"Dan bersabarlah dalam menunggu ketetapan Tuhanmu, maka sesungguhnya kamu berada dalam pengawasan Kami.\"", ref: "QS. At-Tur: 48" },
            { arab: "حَسْبُنَا اللَّهُ وَنِعْمَ الْوَكِيلُ", arti: "\"Cukuplah Allah menjadi Penolong kami dan Allah adalah sebaik-baik Pelindung.\"", ref: "QS. Ali Imran: 173" },
            { arab: "وَعَسَىٰ أَن تَكْرَهُوا شَيْئًا وَهُوَ خَيْرٌ لَّكُمْ", arti: "\"Boleh jadi kamu membenci sesuatu, padahal ia amat baik bagimu.\"", ref: "QS. Al-Baqarah: 216" },
            { arab: "إِنَّمَا يُوَفَّى الصَّابِرُونَ أَجْرَهُم بِغَيْرِ حِسَابٍ", arti: "\"Sesungguhnya hanya orang-orang yang bersabarlah Yang dicukupkan pahala mereka tanpa batas.\"", ref: "QS. Az-Zumar: 10" },
            { arab: "وَمَا خَلَقْتُ الْجِنَّ وَالْإِنسَ إِلَّا لِيَعْبُدُونِ", arti: "\"Dan aku tidak menciptakan jin dan manusia melainkan supaya mereka mengabdi kepada-Ku.\"", ref: "QS. Adz-Dzariyat: 56" },
            { arab: "إِنَّ اللَّهَ يُحِبُّ الْمُتَوَكِّلِينَ", arti: "\"Sesungguhnya Allah menyukai orang-orang yang bertawakkal kepada-Nya.\"", ref: "QS. Ali Imran: 159" },
            { arab: "رَبِّ اشْرَحْ لِي صَدْرِي وَيَسِّرْ لِي أَمْرِي", arti: "\"Ya Tuhanku, lapangkanlah untukku dadaku, dan mudahkanlah untukku urusanku.\"", ref: "QS. Thaha: 25-26" }
        ]);

        const els = {
            date: document.getElementById('date-display'),
            locName: document.getElementById('location-name'),
            clock: document.getElementById('clock-display'),
            nextName: document.getElementById('next-prayer-name'),
            countdown: document.getElementById('countdown-timer'),
            hijri: document.getElementById('hijri-date'),
            list: document.getElementById('prayer-list'),
            qiblatDeg: document.getElementById('qiblat-degree'),
            compassArrow: document.getElementById('compass-arrow'),
            compassDial: document.getElementById('compass-dial'),
            qiblatStatus: document.getElementById('qiblat-status'),
            wTemp: document.getElementById('weather-temp'),
            wDesc: document.getElementById('weather-desc'),
            wIcon: document.getElementById('weather-icon-main'),
            wLoc: document.getElementById('weather-loc-name'),
            wWind: document.getElementById('weather-wind'),
            wRain: document.getElementById('weather-rain'),
            wFeels: document.getElementById('weather-feels'),
            qArab: document.getElementById('quote-arab'),
            qArti: document.getElementById('quote-arti'),
            qRef: document.getElementById('quote-ref'),
            cAmount: document.getElementById('curr-amount'),
            cFrom: document.getElementById('curr-from'),
            cRes: document.getElementById('curr-result'),
            sInput: document.getElementById('search-date-input'),
            sList: document.getElementById('search-result-list'),
            btnStartCompass: document.getElementById('btn-start-compass'),
            // Elements baru untuk pencarian lokasi
            locSearchInput: document.getElementById('loc-search-input'),
            locListContainer: document.getElementById('loc-list-container')
        };

        // Default: Jakarta Pusat
        let currentLoc = cities.find(c => c.n === "Jakarta Pusat") || cities[0];
        let prayerTimes = null;
        let qiblaAngle = 0; 

        function init() {
            // Setup Location Search Logic
            renderLocList(cities); // Render semua kota di awal
            els.locSearchInput.addEventListener('input', (e) => {
                const keyword = e.target.value.toLowerCase();
                const filtered = cities.filter(c => c.n.toLowerCase().includes(keyword));
                renderLocList(filtered);
            });

            els.cAmount.addEventListener('input', calcCurrency);
            els.cFrom.addEventListener('change', calcCurrency);
            els.sInput.addEventListener('change', searchDate);
            els.sInput.valueAsDate = new Date(); 

            updateClock();
            setInterval(updateClock, 1000);
            updateLoc(currentLoc); // Muat lokasi awal
        }

        // Render List Kota di Modal
        function renderLocList(data) {
            if(data.length === 0) {
                els.locListContainer.innerHTML = '<div class="text-center text-gray-400 text-sm mt-4">Lokasi tidak ditemukan</div>';
                return;
            }
            // Batasi render max 100 item agar browser tidak berat jika search kosong
            const limit = 100; 
            let html = '';
            data.slice(0, limit).forEach(c => {
                // Escape string untuk JSON
                const cStr = JSON.stringify(c).replace(/"/g, "&quot;");
                html += `
                <button onclick="app.selectLocation(${cStr})" class="w-full text-left px-4 py-3 bg-white rounded-xl shadow-sm border border-gray-100 flex items-center justify-between tap-effect group">
                    <span class="font-bold text-gray-700 group-hover:text-royal-gold transition-colors">${c.n}</span>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300"></i>
                </button>`;
            });
            if(data.length > limit) {
                html += `<div class="text-center text-xs text-gray-400 mt-2">... ketik untuk mencari lebih spesifik</div>`;
            }
            els.locListContainer.innerHTML = html;
            lucide.createIcons();
        }

        function selectLocation(loc) {
            updateLoc(loc);
            closeModal('location-modal');
        }

        function updateLoc(loc) {
            currentLoc = loc;
            els.locName.innerText = loc.n; // Gunakan property 'n' dari database baru
            fetchPrayer(loc.lat, loc.lng);
            els.wTemp.innerText = "--"; 
            calcQiblaStatic(); 
        }

        async function fetchPrayer(lat, lng) {
            try {
                const date = Math.floor(Date.now() / 1000);
                const res = await fetch(`https://api.aladhan.com/v1/timings/${date}?latitude=${lat}&longitude=${lng}&method=20`);
                const data = await res.json();
                if(data.data) {
                    prayerTimes = data.data.timings;
                    els.hijri.innerText = `${data.data.date.hijri.day} ${data.data.date.hijri.month.en}`;
                    calcNextPrayer(new Date());
                }
            } catch(e) {}
        }

        function updateClock() {
            const now = new Date();
            els.clock.innerText = now.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
            els.date.innerText = now.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long'});
            if(prayerTimes) calcNextPrayer(now);
        }

        function calcNextPrayer(now) {
            if(!prayerTimes) return;
            const pNames = {Fajr:'Subuh', Sunrise:'Terbit', Dhuhr:'Dzuhur', Asr:'Ashar', Maghrib:'Maghrib', Isha:'Isya'};
            const timeToMin = t => { const[h,m]=t.split(':').map(Number); return h*60+m; };
            const nowMin = now.getHours()*60 + now.getMinutes();
            
            let next = null;
            let listHTML = '';
            const pList = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'].map(k => {
                return { key: k, name: pNames[k], time: prayerTimes[k], min: timeToMin(prayerTimes[k]) };
            });

            if(now.getDay() === 5) {
                 const dz = pList.find(x=>x.key==='Dhuhr');
                 if(dz) dz.name = "Jumat";
            }

            for(let p of pList) {
                if(p.name === 'Terbit') continue; 
                if(p.min > nowMin) {
                    next = p;
                    const diffSec = (p.min * 60) - (now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds());
                    const h = Math.floor(diffSec/3600).toString().padStart(2,'0');
                    const m = Math.floor((diffSec%3600)/60).toString().padStart(2,'0');
                    const s = (diffSec%60).toString().padStart(2,'0');
                    els.countdown.innerText = `- ${h}:${m}:${s}`;
                    break;
                }
            }

            if(!next) {
                next = { name: 'Subuh', time: prayerTimes.Fajr };
                els.countdown.innerText = "Istirahat";
            }
            els.nextName.innerText = next.name;

            pList.forEach((p) => {
                const active = (next.name === p.name);
                const isSun = p.name === 'Terbit';
                listHTML += `
                <div class="flex justify-between items-center px-6 py-4 rounded-2xl transition-all duration-300 ${active ? 'prayer-active-3d' : 'prayer-inactive'} ${isSun ? 'opacity-50' : ''}">
                    <div class="flex items-center gap-4">
                        ${active ? '<div class="w-3 h-3 rounded-full bg-royal-gold shadow-neon-gold border border-white"></div>' : (isSun ? '<i data-lucide="sun" class="w-4 h-4 text-gray-400"></i>' : '<div class="w-2 h-2 rounded-full bg-gray-300 shadow-inner"></div>')}
                        <span class="text-sm font-bold ${active ? 'text-white' : 'text-gray-600'} tracking-wide">${p.name}</span>
                    </div>
                    <span class="font-mono text-lg font-bold ${active ? 'text-white text-emboss' : 'text-royal-dark'}">${p.time}</span>
                </div>`;
            });
            els.list.innerHTML = listHTML;
            lucide.createIcons();
        }

        // --- QIBLA LOGIC ---
        function calcQiblaStatic() {
            const lat1 = currentLoc.lat * (Math.PI/180);
            const lon1 = currentLoc.lng * (Math.PI/180);
            const lat2 = 21.422487 * (Math.PI/180); 
            const lon2 = 39.826206 * (Math.PI/180);
            const y = Math.sin(lon2-lon1) * Math.cos(lat2);
            const x = Math.cos(lat1)*Math.sin(lat2) - Math.sin(lat1)*Math.cos(lat2)*Math.cos(lon2-lon1);
            qiblaAngle = (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
            
            els.qiblatDeg.innerText = Math.round(qiblaAngle) + "°";
            els.compassArrow.style.transform = `rotate(${qiblaAngle}deg)`;
            els.compassDial.style.transform = `rotate(0deg)`;
            els.qiblatStatus.innerText = "Mode Kalkulasi (Statis)";
            els.qiblatStatus.classList.remove("text-green-600");
        }

        function startCompass() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation, true);
                            uiCompassActive();
                        } else {
                            alert("Izin sensor ditolak. Pastikan menggunakan HTTPS.");
                        }
                    })
                    .catch(console.error);
            } else if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientationabsolute', handleOrientation, true);
                window.addEventListener('deviceorientation', handleOrientation, true);
                uiCompassActive();
            } else {
                alert("Perangkat tidak mendukung sensor kompas.");
            }
        }

        function uiCompassActive() {
            els.btnStartCompass.style.display = 'none';
            els.qiblatStatus.innerText = "Mode Sensor Live (GPS Aktif)";
            els.qiblatStatus.classList.add("text-green-600");
        }

        function handleOrientation(event) {
            let alpha = null;
            if(event.webkitCompassHeading) {
                alpha = event.webkitCompassHeading; 
            } else if (event.absolute && event.alpha !== null) {
                alpha = 360 - event.alpha;
            } else if (event.alpha !== null) {
                alpha = 360 - event.alpha; 
            }

            if (alpha !== null) {
                els.compassDial.style.transform = `rotate(${-alpha}deg)`;
                const needleRotation = qiblaAngle - alpha;
                els.compassArrow.style.transform = `rotate(${needleRotation}deg)`;
            }
        }

        // --- MODAL UTILS ---
        function openModal(id) {
            document.getElementById(id).classList.add('active');
            if(id==='weather-modal') fetchWeather();
            if(id==='currency-modal') calcCurrency();
            if(id==='quote-modal') renderQuote();
            // Reset search input saat modal lokasi dibuka
            if(id==='location-modal') {
                els.locSearchInput.value = '';
                renderLocList(cities);
                setTimeout(() => els.locSearchInput.focus(), 300);
            }
        }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function renderQuote() {
            els.qArab.style.opacity = 0;
            els.qArti.style.opacity = 0;
            setTimeout(() => {
                const r = quotesDb[Math.floor(Math.random() * quotesDb.length)];
                els.qArab.innerText = r.arab;
                els.qArti.innerText = r.arti;
                els.qRef.innerText = r.ref;
                els.qArab.style.opacity = 1;
                els.qArti.style.opacity = 1;
            }, 300);
        }

        async function searchDate() {
            const dVal = els.sInput.value;
            if(!dVal) return;
            const [y,m,d] = dVal.split('-');
            const dateStr = `${d}-${m}-${y}`;
            els.sList.innerHTML = '<div class="text-center text-xs p-4 text-gray-500">Memuat data...</div>';
            try {
                const res = await fetch(`https://api.aladhan.com/v1/timings/${dateStr}?latitude=${currentLoc.lat}&longitude=${currentLoc.lng}&method=20`);
                const data = await res.json();
                const t = data.data.timings;
                const p = [
                    {n:'Subuh', v:t.Fajr}, {n:'Terbit', v:t.Sunrise}, {n:'Dzuhur', v:t.Dhuhr},
                    {n:'Ashar', v:t.Asr}, {n:'Maghrib', v:t.Maghrib}, {n:'Isya', v:t.Isha}
                ];
                let html = '';
                p.forEach(x => {
                    html += `<div class="flex justify-between items-center p-4 bg-white/50 shadow-sm border border-white rounded-2xl mb-2">
                        <span class="text-sm font-bold text-gray-600">${x.n}</span>
                        <span class="text-lg font-mono font-bold text-royal-dark text-emboss">${x.v}</span>
                    </div>`;
                });
                els.sList.innerHTML = html;
            } catch(e) { els.sList.innerHTML = 'Gagal memuat data'; }
        }

        async function fetchWeather() {
            els.wLoc.innerText = currentLoc.n;
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${currentLoc.lat}&longitude=${currentLoc.lng}&current=temperature_2m,apparent_temperature,is_day,weather_code,wind_speed_10m&daily=precipitation_probability_max&timezone=auto`);
                const d = await res.json();
                if(d.current) {
                    els.wTemp.innerText = Math.round(d.current.temperature_2m);
                    els.wDesc.innerText = getWeatherCode(d.current.weather_code);
                    const iconName = getWeatherIcon(d.current.weather_code, d.current.is_day);
                    els.wIcon.setAttribute('data-lucide', iconName);
                    lucide.createIcons();
                    els.wFeels.innerText = Math.round(d.current.apparent_temperature) + "°";
                    els.wWind.innerText = d.current.wind_speed_10m + " km/h";
                    els.wRain.innerText = (d.daily.precipitation_probability_max?.[0] || 0) + "%";
                }
            } catch(e){ els.wDesc.innerText = "N/A"; }
        }

        function getWeatherCode(c) {
            if(c===0) return "Cerah"; if(c<=3) return "Berawan"; if(c===45 || c===48) return "Berkabut";
            if(c>=51 && c<=55) return "Gerimis"; if(c>=61 && c<=65) return "Hujan"; if(c>=80) return "Hujan Lebat";
            return "Mendung";
        }

        function getWeatherIcon(c, isDay) {
            if(c === 0) return isDay ? "sun" : "moon"; if(c <= 3) return isDay ? "cloud-sun" : "cloud-moon";
            if(c >= 51) return "cloud-drizzle"; if(c >= 80) return "cloud-lightning";
            return "cloud";
        }

        async function calcCurrency() {
            els.cRes.innerText = "...";
            try {
                const res = await fetch(`https://api.frankfurter.app/latest?amount=${els.cAmount.value}&from=${els.cFrom.value}&to=IDR`);
                const d = await res.json();
                els.cRes.innerText = "Rp " + d.rates.IDR.toLocaleString('id-ID', {maximumFractionDigits:0});
            } catch(e) { els.cRes.innerText = "Error"; }
        }

        init();

        return { openModal, closeModal, renderQuote, startCompass, selectLocation };
    })();
    </script>
</body>
</html>
